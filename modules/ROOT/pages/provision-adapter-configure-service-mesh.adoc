= Provision the Adapter
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:keywords: service mesh, microservices, installation prerequisites


Before you can start managing your services using Service Mesh, you must prepare your namespace by provisioning a Service Mesh adapter. Provisioning prepares the namespace for the Service Mesh configuration. 

The adapter microgateway behaves as the policy enforcement component, which fetches policies from Anypoint platform, checks whether the policies have been met, and then reports the analytics data back to Anypoint Platform.  The adapter intercepts all communications between the services and the corresponding APIs to ensure security and fault detection.

[PA: Any best practice as to the number of namespaces and adapters per service?]

When you provision the adapter, specify the size of the adapter based on the number of CPUs and memory of the system managed in Service Mesh. After you provision the adapter, you must redeploy all your existing applications to ensure that the Envoy sidecar is injected within each pod in the Kubernetes cluster.

== Adapter Plan

When you provision the adapter, you must specify the size of the adapter based on the number of CPUs and memory of the system that will be managed using Service Mesh. Anypoint Service Mesh currently supports small, medium, and large adapter plans:

[%header%autowidth.spread]
|===
| Plan | CPU (cores) | Memory (GiB) | API Limit
| small | .5 | 1 | 25
| medium | 1 | 1.5 | 50
| large | 2 | 2 | 100
|===

You can also modify the size of an adapter after it has been provisioned. If you update the plan size, the adapter deployment is updated appropriately. Kubernetes then creates a pod with new information. However, the old adapter continues handling requests until the new pod is ready.

After the new adapter is ready, the old pod is terminated and all requests are routed to the new adapter. If the update fails to start up a new pod due to insufficient space, or if the pod is not ready, an error message is recorded in a Kubernetes event. In such a scenario, the old adapter continues to handle requests because the new pod is not yet available.

// === Adapter Status

// When you provision an adapter, or bind the adapter to an application, a message is displayed after you run an adapter command. The message indicates whether the adapter was created, deleted, or modified successfully. 

// Additionally, you can verify the adapter status, which provides further details about the adapter. 

// To view the adapter status, type the following command:

// `./service-mesh adapter list`

// The status values include:

// * Ready--The adapter is now ready to be used. 
// * Failed--The adapter was not created successfully. An error occurred. 
// * Provisioning--The adapter is in the process of being provisioned.

== CLI Help for Adapter Commands

After you install Service Mesh, you can use the command line interface (CLI) help to learn about the Service Mesh commands and their parameters:
+
`./service-mesh adapter help`

image::service-mesh-cli-adapter-help.png[CLI Help for Adapter Commands]

== Provisioning the adapter

To provision the Anypoint Service Mesh adapter:
 
. Determine the adapter size based on the plan.
. From Anypoint Platform, obtain the the client ID and client secret for your environment.
For more information about how to obtain these credentials, see 
xref:api-manager::access-client-app-id-task.adoc[obtain credentials].
. From the Service Mesh installer download location in the Command window, type the following command to create the adapter:
+
[source,text,linenums]
----
./service-mesh adapter create \
--name=<adapter name> \
--namespace=<adapter namespace> \
--size=<adapter plan size> \
--clientId=<clientId of the environment or organization> \
--clientSecret=<client secret of the environment or organization> \
--platformUri=<URL of Anypoint Platform>
----
Note that all objects names, such as adapter name, binding name, and service name, must all be in lower case. An error is thrown if you do not follow Kubernetes naming conventions.
+
[%header%autowidth.spread]
|===
| Parameter Name | Description | Required/Optional | Default Value
| `name` | The name of the adapter that you want to create, for example, “service-mesh-test-adapter”. | Required | N/A
| `namespace` | The namespace in which you want to create the adapter, for example, “mulesoft-apps”. | Optional | default
| `size`| The size of the adapter based on the number of CPUs and memory to use | Optional | medium
| `clientId` | The client ID of the environment (recommended) or the organization. Use the client ID that you obtained as part of the permission and roles prerequisites as explained in this document. | Required | N/A
| `clientSecret` | The client secret of the environment (recommended) or the organization. Use the client secret that you obtained as part of the permission and roles prerequisites as explained in this document.| Required | N/A
| `platformUri` | The URL of the host where Anypoint Platform is installed | Optional | https://anypoint.mulesoft.com
|===
+
. Verify the adapter status:
+
`./service-mesh adapter list`
+
image::provision-service-mesh-adapter-output.png[Example Output]
+
. Review adapter logs to see detailed information about Kubernetes events and adapter transactions:
+
`./service-mesh adapter logs --name=<adapter_name> --namespace=<namespace>`
. Optionally, run the following commands for each of your applications that were already running in the namespace before starting the Service Mesh installation:
.. Determine the deployment name for the patch: 
+
`kubectl get deployments -n <namespace>`
+
//image::kubectl-deployment-name.png[]
.. Using the deploy name from the previous command, restart your application to inject the sidecar in the pod:
+
`kubectl -n <adapter-namespace> patch deploy <deployname> --type=json -p='[{"op": "replace", "path": "/spec/template/metadata/labels/service-mesh.mulesoft.com","value":"enable"}]'`
//how to test the deployment status and other details--using a k8 command.


